name: CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    continue-on-error: false

    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      id: install
      run: |
        sudo apt-get update
        sudo apt-get install -y openssl shellcheck
      if: success()

    - name: Shell script syntax check
      id: lint
      run: |
        shellcheck generate-ssl-cert.sh
        shellcheck install-proxmox-cert.sh
        shellcheck tests/run-tests.sh
        shellcheck tests/advanced-tests.sh
        shellcheck tests/performance-tests.sh
      if: steps.install.outcome == 'success'

    - name: Run basic test suite
      id: basic_tests
      run: |
        cd tests
        ./run-tests.sh
      if: steps.lint.outcome == 'success'

    - name: Run advanced test suite
      id: advanced_tests
      run: |
        cd tests
        ./advanced-tests.sh
      if: steps.basic_tests.outcome == 'success'

    - name: Run performance tests
      id: perf_tests
      run: |
        cd tests
        ./performance-tests.sh
        ./metrics-summary.sh
      if: steps.advanced_tests.outcome == 'success'

    - name: Security scan
      id: security
      uses: github/codeql-action/init@v2
      with:
        languages: shell
      if: steps.perf_tests.outcome == 'success'

    - name: Run CodeQL Analysis
      id: codeql
      uses: github/codeql-action/analyze@v2
      if: steps.security.outcome == 'success'

    - name: Upload test artifacts
      uses: actions/upload-artifact@v2
      if: always()
      with:
        name: test-results
        path: |
          tests/test_results/reports/
          tests/test_results/metrics/
          tests/test_results/backups/

    - name: Generate test summary
      id: summary
      if: always()
      run: |
        {
          echo "# Test Results Summary"
          echo
          echo "## Test Suites"
          echo "- Basic Tests: ${{ steps.basic_tests.outcome }}"
          echo "- Advanced Tests: ${{ steps.advanced_tests.outcome }}"
          echo "- Performance Tests: ${{ steps.perf_tests.outcome }}"
          echo "- Security Scan: ${{ steps.security.outcome }}"
          echo "- CodeQL Analysis: ${{ steps.codeql.outcome }}"
          echo
          echo "## Performance Metrics"
          if [ -f "tests/test_results/reports/metrics-summary.md" ]; then
            cat tests/test_results/reports/metrics-summary.md
          else
            echo "No performance metrics available"
          fi
        } > test_summary.md

    - name: Send email on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{secrets.SMTP_SERVER}}
        server_port: ${{secrets.SMTP_PORT}}
        username: ${{secrets.SMTP_USERNAME}}
        password: ${{secrets.SMTP_PASSWORD}}
        subject: "⚠️ SSL Certificate Generator: Tests Failed"
        body_path: test_summary.md
        to: ${{secrets.NOTIFICATION_EMAIL}}
        from: SSL Certificate Generator CI <${{secrets.SMTP_USERNAME}}>
        content_type: text/markdown
        attachments: tests/test_results/reports/metrics-summary.md

    - name: Send success notification
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{secrets.SMTP_SERVER}}
        server_port: ${{secrets.SMTP_PORT}}
        username: ${{secrets.SMTP_USERNAME}}
        password: ${{secrets.SMTP_PASSWORD}}
        subject: "✅ SSL Certificate Generator: All Tests Passed"
        body_path: test_summary.md
        to: ${{secrets.NOTIFICATION_EMAIL}}
        from: SSL Certificate Generator CI <${{secrets.SMTP_USERNAME}}>
        content_type: text/markdown
        attachments: tests/test_results/reports/metrics-summary.md

    - name: Upload test summary
      uses: actions/upload-artifact@v2
      if: always()
      with:
        name: test-summary
        path: test_summary.md

